name: Build and Release

on:
  push:
    tags:
      - 'v*'  # v1.0.0, v1.2.3 등 버전 태그 push 시 실행

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore winforms/RoMarketCrawler/RoMarketCrawler.csproj

    - name: Publish
      run: dotnet publish winforms/RoMarketCrawler/RoMarketCrawler.csproj -c Release -o ./publish

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Calculate SHA256
      id: sha256
      run: |
        $hash = (Get-FileHash ./publish/RoMarketCrawler.exe -Algorithm SHA256).Hash
        echo "HASH=$hash" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Get expiration date from code
      id: expiration
      run: |
        $content = Get-Content -Path "winforms/RoMarketCrawler/Services/StartupValidator.cs" -Raw
        if ($content -match 'ExpirationDateKST\s*=\s*"([^"]+)"') {
          $date = $matches[1].Substring(0, 10)
          echo "DATE=$date" >> $env:GITHUB_OUTPUT
        } else {
          echo "DATE=무제한" >> $env:GITHUB_OUTPUT
        }
      shell: pwsh

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## RO Market Crawler ${{ steps.get_version.outputs.VERSION }}

          ### 사용 가능 기간
          **~${{ steps.expiration.outputs.DATE }}** 까지 사용 가능합니다.

          ### 다운로드
          아래 `RoMarketCrawler.exe` 파일을 다운로드하세요.

          ---

          ## 주요 변경사항

          ### 신규 기능
          - (사용자가 이해할 수 있는 설명)

          ### 개선
          - (사용자가 이해할 수 있는 설명)

          ### 버그 수정
          - (사용자가 이해할 수 있는 설명)

          > 시스템 내부 변경은 제외합니다. 카테고리는 해당하는 것만 사용하세요.

          ---

          ### 파일 검증 (SHA256)
          ```
          ${{ steps.sha256.outputs.HASH }}
          ```

          PowerShell에서 확인:
          ```powershell
          Get-FileHash RoMarketCrawler.exe -Algorithm SHA256
          ```
        files: ./publish/RoMarketCrawler.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
