name: Build and Release

on:
  push:
    tags:
      - 'v*'  # v1.0.0, v1.2.3 등 버전 태그 push 시 실행

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore winforms/RoMarketCrawler/RoMarketCrawler.csproj

    - name: Publish
      run: dotnet publish winforms/RoMarketCrawler/RoMarketCrawler.csproj -c Release -o ./publish

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Calculate SHA256
      id: sha256
      run: |
        $hash = (Get-FileHash ./publish/RoMarketCrawler.exe -Algorithm SHA256).Hash
        echo "HASH=$hash" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Get expiration date from code
      id: expiration
      run: |
        $content = Get-Content -Path "winforms/RoMarketCrawler/Services/StartupValidator.cs" -Raw
        if ($content -match 'ExpirationDateKST\s*=\s*"([^"]+)"') {
          $date = $matches[1].Substring(0, 10)
          echo "DATE=$date" >> $env:GITHUB_OUTPUT
        } else {
          echo "DATE=무제한" >> $env:GITHUB_OUTPUT
        }
      shell: pwsh

    - name: Upload asset to existing Release
      uses: softprops/action-gh-release@v1
      with:
        files: ./publish/RoMarketCrawler.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
