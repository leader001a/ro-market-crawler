# GNJOY API 안정성 분석 보고서

## 1. 개요

### 1.1 문제 상황
- GNJOY 노점조회 API 사용 중 차단(Rate Limiting) 현상 빈번 발생
- 모니터링 기능과 수동 검색 동시 사용 시 불안정

### 1.2 분석 범위
- 현재 구현된 요청 패턴 분석
- 차단 원인 추정
- 안정화 방안 비교 및 권장

---

## 2. 현재 구현 분석

### 2.1 GnjoyClient 설정

| 항목 | 현재 설정 |
|------|----------|
| Google Proxy | **비활성화** (직접 호출) |
| User-Agent | Chrome 브라우저 위장 |
| 연결 풀 | 서버당 최대 10개 |
| 재시도 | 3회, 1초 딜레이 |
| 타임아웃 | 30초 |

### 2.2 모니터링 요청 패턴

```
설정: 아이템 10개, 갱신주기 10초

초기 시작 (spacing 적용):
- spacing = 10초 / 10개 = 1초 간격
- 아이템1: 0초 → 아이템2: 1초 → ... → 아이템10: 9초

이후 동작 (개별 카운팅):
- 각 아이템이 조회 완료 후 10초 뒤 재조회
- spacing이 유지되어 1초 간격 분산 유지
```

### 2.3 요청 집중 시나리오

```
[모니터링 동작 중 노점조회 실행 시]

20초: 모니터링 아이템1 조회
20초: ★ 사용자 노점검색 ★
      → 검색 API 1회
      → 상세조회 10회 (카드/인챈트/랜덤옵션)
21초: 모니터링 아이템2 조회

→ 1초 내 약 12회 요청 집중 = 차단 위험
```

---

## 3. GNJOY 차단 메커니즘 추정

### 3.1 Rate Limiting 패턴

| 유형 | 설명 | 가능성 |
|------|------|--------|
| IP 기반 | 동일 IP에서 일정 시간 내 요청 수 제한 | **높음** |
| 버스트 탐지 | 짧은 시간 내 연속 요청 탐지 | **높음** |
| 세션 추적 | 쿠키 없는 요청 의심 | 중간 |
| User-Agent 검사 | 봇 탐지 | 낮음 |

### 3.2 추정 임계값

```
- 초당 요청: 2~3회 이상 시 위험
- 분당 요청: 30~60회 이상 시 위험
- 버스트: 3초 내 10회 이상 시 즉시 차단 가능
```

---

## 4. 안정화 방안 비교

### 4.1 방안 A: Google Proxy 활용 (kafra.kr 방식)

#### 구현 방식
```
클라이언트 → Google OpenSocial Proxy → GNJOY 서버

URL 변환:
https://ro.gnjoy.com/deal/search.asp
→ https://images0-focus-opensocial.googleusercontent.com/gadgets/proxy?container=focus&url=https://ro.gnjoy.com/deal/search.asp
```

#### 장점
| 항목 | 설명 |
|------|------|
| IP 분산 | Google 서버 IP로 요청되어 클라이언트 IP 숨김 |
| 구현 간단 | URL 변환만으로 적용 가능 |
| kafra.kr 검증 | 실제 서비스에서 사용 중인 방식 |

#### 단점
| 항목 | 설명 |
|------|------|
| Google 정책 의존 | Google이 프록시 서비스 중단 가능 |
| 지연 시간 | 프록시 경유로 응답 지연 (100~300ms 추가) |
| 불안정성 | 현재 GnjoyClient에서 "doesn't work reliably" 주석 |
| CORS/쿠키 | 웹 브라우저용 설계, 데스크톱 앱에서 제한적 |

#### 현재 비활성화 이유 (코드 주석)
```csharp
// NOTE: Disabled because Google OpenSocial proxy doesn't work reliably with GNJOY server
// kafra.kr uses this for browser-based requests, but desktop apps can call GNJOY directly
```

#### 평가
```
kafra.kr는 웹 브라우저 기반 → CORS 우회 + IP 분산 목적으로 효과적
본 프로젝트는 데스크톱 앱 → CORS 불필요, 프록시 안정성 문제 있음

권장: 데스크톱 앱에서는 직접 호출 + 요청 제어가 더 적합
```

---

### 4.2 방안 B: 전역 요청 스케줄러 (권장)

#### 구현 방식
```
┌─────────────────────────────────────────────────────┐
│              GnjoyRequestScheduler                  │
├─────────────────────────────────────────────────────┤
│  [우선순위 큐]                                       │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐             │
│  │ 수동검색 │ > │ 상세조회 │ > │ 모니터링 │             │
│  │ (높음)   │  │ (중간)   │  │ (낮음)   │             │
│  └─────────┘  └─────────┘  └─────────┘             │
│                     ↓                               │
│         [최소 간격 2초 보장]                          │
│                     ↓                               │
│              GNJOY 서버                             │
└─────────────────────────────────────────────────────┘
```

#### 장점
| 항목 | 설명 |
|------|------|
| 완벽한 제어 | 모든 요청의 간격과 순서 제어 가능 |
| 우선순위 | 사용자 체감 속도 유지 (수동 검색 우선) |
| 독립성 | 외부 서비스 의존 없음 |
| 확장성 | 향후 기능 추가에도 안정성 유지 |

#### 단점
| 항목 | 설명 |
|------|------|
| 구현 복잡도 | 큐 관리 로직 필요 |
| 지연 가능 | 요청이 많으면 대기 시간 발생 |

#### 동작 예시
```
시간  요청 발생         큐 상태              실제 전송
───────────────────────────────────────────────────────
0초   모니터링 A       [A]                  A 전송
1초   모니터링 B       [B]                  대기
1.5초 수동검색 C       [C(높음), B(낮음)]    대기
2초   -               [B]                  C 전송 (우선)
4초   -               []                   B 전송
```

---

### 4.3 방안 C: 하이브리드 (Proxy + 스케줄러)

#### 구현 방식
```
전역 스케줄러로 요청 제어 + Google Proxy로 IP 분산

장점: 이중 보호
단점: 복잡도 증가, Proxy 불안정성 여전히 존재
```

#### 평가
```
Proxy의 불안정성이 해결되지 않으면 오히려 장애 포인트 증가
권장하지 않음
```

---

### 4.4 방안 비교 요약

| 방안 | 구현 난이도 | 안정성 | 외부 의존 | 권장 |
|------|------------|--------|----------|------|
| A. Google Proxy | 낮음 | 중간 | 높음 | X |
| B. 전역 스케줄러 | 중간 | 높음 | 없음 | **O** |
| C. 하이브리드 | 높음 | 중간 | 높음 | X |

---

## 5. 권장 구현: 전역 요청 스케줄러

### 5.1 핵심 설계

```csharp
public class GnjoyRequestScheduler
{
    // 우선순위 큐
    private PriorityQueue<RequestItem, int> _queue;

    // 최소 요청 간격
    private const int MinIntervalMs = 2000; // 2초

    // 마지막 요청 시간
    private DateTime _lastRequestTime;

    // 우선순위 정의
    public enum Priority
    {
        High = 1,    // 수동 검색
        Medium = 2,  // 상세 조회
        Low = 3      // 모니터링 자동 조회
    }
}
```

### 5.2 요청 처리 흐름

```
1. 요청 등록: EnqueueAsync(url, priority)
2. 큐 처리 루프:
   - 우선순위 높은 요청 선택
   - 마지막 요청 후 2초 경과 확인
   - 미경과 시 대기
   - 요청 실행 및 결과 반환
3. 결과 반환: Task<T> 완료
```

### 5.3 추가 기능 (선택)

| 기능 | 설명 |
|------|------|
| 지능형 백오프 | 에러 발생 시 간격 자동 증가 (2초→4초→8초) |
| 큐 상태 표시 | UI에 "대기 중: N개" 표시 |
| 모니터링 스킵 | 큐가 길면 오래된 모니터링 요청 스킵 |
| 통계 수집 | 요청 성공률, 평균 응답 시간 기록 |

---

## 6. 예상 효과

### 6.1 Before (현재)

```
모니터링 10개(10초) + 노점검색 동시 실행
→ 1초 내 12회 요청 집중
→ 차단 위험 높음
```

### 6.2 After (스케줄러 적용)

```
모니터링 10개(10초) + 노점검색 동시 실행
→ 모든 요청 2초 간격 보장
→ 노점검색 우선 처리 (체감 속도 유지)
→ 모니터링은 약간 지연되지만 안정적 동작
```

### 6.3 수치 비교

| 항목 | Before | After |
|------|--------|-------|
| 최소 요청 간격 | 0초 (동시 가능) | 2초 (보장) |
| 버스트 요청 | 발생 가능 | 불가능 |
| 차단 위험 | 높음 | 매우 낮음 |
| 수동 검색 체감 | 빠름 | 동일 (우선순위) |
| 모니터링 정확도 | 불안정 | 약간 지연되나 안정 |

---

## 7. 결론

### 7.1 핵심 권장사항

1. **전역 요청 스케줄러 도입** (방안 B)
   - 모든 GNJOY API 요청을 단일 스케줄러로 관리
   - 최소 2초 간격 보장
   - 우선순위 기반 처리 (수동 > 상세 > 모니터링)

2. **Google Proxy는 권장하지 않음** (방안 A)
   - 데스크톱 앱에서 불안정
   - 외부 서비스 의존성
   - kafra.kr는 웹 브라우저용으로 적합, 본 프로젝트와 환경 다름

### 7.2 구현 우선순위

| 순서 | 항목 | 효과 |
|------|------|------|
| 1 | 기본 스케줄러 (2초 간격) | 차단 방지 |
| 2 | 우선순위 큐 | 사용자 체감 유지 |
| 3 | 지능형 백오프 (선택) | 추가 안정성 |
| 4 | 상태 표시 UI (선택) | 사용자 피드백 |

---

## 8. 부록: kafra.kr Proxy 방식 상세

### 8.1 Google OpenSocial Proxy 원리

```
목적: CORS 우회 + IP 분산

원본 요청:
https://ro.gnjoy.com/deal/search.asp?item=포링

프록시 요청:
https://images0-focus-opensocial.googleusercontent.com/gadgets/proxy
  ?container=focus
  &url=https://ro.gnjoy.com/deal/search.asp?item=포링

동작:
1. 브라우저가 Google 서버에 요청
2. Google 서버가 GNJOY에 대리 요청
3. Google 서버가 응답 반환
4. GNJOY 입장에서는 Google IP로 요청 수신
```

### 8.2 kafra.kr에서 효과적인 이유

| 항목 | 설명 |
|------|------|
| 환경 | 웹 브라우저 기반 |
| CORS | 브라우저 보안 정책 우회 필수 |
| 다중 사용자 | 여러 사용자가 분산 요청 |
| IP 분산 | Google 서버 풀로 자연스러운 분산 |

### 8.3 본 프로젝트에서 부적합한 이유

| 항목 | 설명 |
|------|------|
| 환경 | 데스크톱 앱 (WinForms) |
| CORS | 불필요 (브라우저 아님) |
| 단일 사용자 | 한 사용자가 모든 요청 |
| Proxy 불안정 | 간헐적 실패, 지연 발생 |
| 의존성 | Google 정책 변경 시 서비스 중단 |

---

## 9. 구현 완료 (2025-12-14)

### 9.1 구현된 파일

| 파일 | 변경 내용 |
|------|----------|
| `Services/GnjoyRequestScheduler.cs` | 신규 - 전역 요청 스케줄러 (싱글톤) |
| `Services/GnjoyClient.cs` | 수정 - 스케줄러를 통한 요청 처리 |
| `Services/MonitoringService.cs` | 수정 - Low 우선순위 적용 |
| `Form1.cs` | 수정 - 종료 시 스케줄러 Shutdown |
| `Form1.DealTab.cs` | 수정 - High 우선순위 적용 |

### 9.2 구현된 기능

1. **전역 요청 스케줄러 (GnjoyRequestScheduler)**
   - 싱글톤 패턴으로 모든 GnjoyClient 인스턴스 공유
   - 최소 2초 간격 보장
   - 우선순위 큐 (High > Medium > Low)
   - 최대 100개 대기열 관리
   - 큐 초과 시 Low 우선순위 자동 스킵

2. **우선순위 적용**
   - **High**: 수동 노점 검색 (사용자 즉시 반응 필요)
   - **Medium**: 상세 정보 조회 (카드/인챈트/랜덤옵션)
   - **Low**: 모니터링 자동 조회 (백그라운드 작업)

3. **안전한 종료**
   - Form 종료 시 스케줄러 Shutdown 호출
   - 대기 중인 요청 자동 취소

### 9.3 동작 방식

```
[사용자 노점 검색] → Priority.High → 즉시 큐 우선 처리
[상세 정보 조회]   → Priority.Medium → 다음 순서
[모니터링 자동]    → Priority.Low → 마지막 순서

모든 요청 → [스케줄러 큐] → 2초 간격 보장 → GNJOY 서버
```

### 9.4 예상 결과

- 모니터링 10개 + 수동 검색 동시 실행 시:
  - 수동 검색이 우선 처리됨
  - 모든 요청이 2초 간격으로 안전하게 처리
  - GNJOY 차단 위험 대폭 감소

---

*작성일: 2025-12-14*
*분석 대상: RoMarketCrawler v1.x*
*구현 완료: 2025-12-14*
